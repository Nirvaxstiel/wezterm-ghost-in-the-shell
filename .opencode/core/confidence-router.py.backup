"""
Confidence-Based Task Router
Routes tasks based on confidence scores

Purpose: +15% reliability through appropriate escalation
Based on: Agent patterns and research on confidence-based routing
"""

import re
import yaml
from typing import Dict, List, Tuple, Optional, Any
from enum import Enum


class EscalationAction(Enum):
    """Possible escalation actions"""
    PROCEED_DIRECT = "proceed_direct"
    VERIFY = "verify"
    ASK_USER = "ask_user"
    ESCALATE = "escalate"


class TaskDifficulty(Enum):
    """Task difficulty levels"""
    SIMPLE = "simple"
    MEDIUM = "medium"
    COMPLEX = "complex"
    CRITICAL = "critical"


class ConfidenceRouter:
    """Route tasks based on confidence scores"""

    # Complexity indicators for each difficulty level
    COMPLEXITY_PATTERNS = {
        TaskDifficulty.SIMPLE: [
            'fix typo', 'add comment', 'rename variable', 'format code',
            'update doc', 'change text', 'adjust style', 'remove unused'
        ],
        TaskDifficulty.MEDIUM: [
            'add feature', 'refactor function', 'update doc', 'add test',
            'modify config', 'update endpoint', 'change logic', 'implement function'
        ],
        TaskDifficulty.COMPLEX: [
            'implement system', 'migrate codebase', 'optimize architecture',
            'integrate api', 'redesign component', 'add auth', 'add caching',
            'create microservice', 'build pipeline', 'setup infrastructure'
        ],
        TaskDifficulty.CRITICAL: [
            'security fix', 'data migration', 'payment integration',
            'auth implementation', 'database migration', 'api deprecation',
            'production deployment', 'critical bug fix', 'data loss risk'
        ]
    }

    def __init__(self, config_path: str = ".opencode/config/confidence-routes.yaml"):
        """
        Initialize confidence router

        Args:
            config_path: Path to configuration file
        """
        self.config = self._load_config(config_path)
        self._cache = {}  # Cache for routing decisions

    def _load_config(self, config_path: str) -> Dict[str, Any]:
        """Load confidence routing configuration"""
        try:
            with open(config_path, 'r') as f:
                return yaml.safe_load(f)
        except FileNotFoundError:
            # Default configuration
            return {
                'escalation_rules': {
                    'low_confidence': {'threshold': 0.7},
                    'very_low_confidence': {'threshold': 0.5},
                    'high_confidence': {'threshold': 0.9}
                },
                'task_difficulty_multipliers': {
                    'simple': {'multiplier': 1.0},
                    'medium': {'multiplier': 1.1},
                    'complex': {'multiplier': 1.2},
                    'critical': {'multiplier': 1.3}
                },
                'confidence_thresholds': {
                    'default': 0.7,
                    'simple': 0.6,
                    'medium': 0.7,
                    'complex': 0.8,
                    'critical': 0.9
                },
                'intent_rules': {}
            }
        except yaml.YAMLError as e:
            print(f"Warning: Failed to load config, using defaults: {e}")
            return self._get_default_config()

    def _get_default_config(self) -> Dict[str, Any]:
        """Get default configuration"""
        return {
            'escalation_rules': {
                'low_confidence': {'threshold': 0.7},
                'very_low_confidence': {'threshold': 0.5},
                'high_confidence': {'threshold': 0.9}
            },
            'task_difficulty_multipliers': {
                'simple': {'multiplier': 1.0},
                'medium': {'multiplier': 1.1},
                'complex': {'multiplier': 1.2},
                'critical': {'multiplier': 1.3}
            },
            'confidence_thresholds': {
                'default': 0.7,
                'simple': 0.6,
                'medium': 0.7,
                'complex': 0.8,
                'critical': 0.9
            },
            'intent_rules': {}
        }

    def classify_difficulty(self, task: str) -> TaskDifficulty:
        """
        Classify task difficulty

        Args:
            task: User task description

        Returns:
            TaskDifficulty enum value
        """
        task_lower = task.lower()

        # Check critical first (most specific)
        for pattern in self.COMPLEXITY_PATTERNS[TaskDifficulty.CRITICAL]:
            if pattern in task_lower:
                return TaskDifficulty.CRITICAL

        # Then complex
        for pattern in self.COMPLEXITY_PATTERNS[TaskDifficulty.COMPLEX]:
            if pattern in task_lower:
                return TaskDifficulty.COMPLEX

        # Then simple
        for pattern in self.COMPLEXITY_PATTERNS[TaskDifficulty.SIMPLE]:
            if pattern in task_lower:
                return TaskDifficulty.SIMPLE

        # Default to medium
        return TaskDifficulty.MEDIUM

    def get_difficulty_multiplier(self, difficulty: TaskDifficulty) -> float:
        """
        Get difficulty multiplier from config

        Args:
            difficulty: Task difficulty level

        Returns:
            Multiplier value (e.g., 1.0, 1.1, 1.2, 1.3)
        """
        multipliers = self.config.get('task_difficulty_multipliers', {})

        for diff_key, diff_data in multipliers.items():
            if diff_key.value == difficulty.value:
                return diff_data.get('multiplier', 1.0)

        return 1.0  # Default multiplier

    def get_confidence_threshold(
        self,
        difficulty: TaskDifficulty,
        intent: Optional[str] = None
    ) -> float:
        """
        Get confidence threshold for task

        Args:
            difficulty: Task difficulty level
            intent: Optional intent (for intent-specific thresholds)

        Returns:
            Confidence threshold value
        """
        thresholds = self.config.get('confidence_thresholds', {})

        # Check intent-specific threshold first
        if intent:
            intent_rules = self.config.get('intent_rules', {})
            if intent in intent_rules:
                intent_threshold = intent_rules[intent].get('default_threshold')
                if intent_threshold is not None:
                    return intent_threshold

        # Use difficulty-specific threshold
        difficulty_key = difficulty.value
        if difficulty_key in thresholds:
            base_threshold = thresholds[difficulty_key]
            multiplier = self.get_difficulty_multiplier(difficulty)
            return base_threshold * multiplier

        # Default threshold
        return thresholds.get('default', 0.7)

    def route_task(
        self,
        task: str,
        confidence: float,
        intent: Optional[str] = None
    ) -> Dict[str, Any]:
        """
        Route task based on confidence

        Args:
            task: User task description
            confidence: Confidence score (0.0 to 1.0)
            intent: Optional intent classification

        Returns:
            Dictionary with routing decision
        """
        # Classify task difficulty
        difficulty = self.classify_difficulty(task)

        # Get threshold for this difficulty
        threshold = self.get_confidence_threshold(difficulty, intent)

        # Determine escalation level
        escalation_rules = self.config.get('escalation_rules', {})

        if confidence >= threshold:
            # High confidence - proceed directly
            return {
                'action': EscalationAction.PROCEED_DIRECT,
                'route_to': None,
                'difficulty': difficulty.value,
                'confidence': confidence,
                'threshold': threshold,
                'reason': f"Confidence {confidence:.2f} >= threshold {threshold:.2f} for {difficulty.value} task",
                'description': "High confidence, proceeding directly",
                'verification_needed': False
            }
        elif confidence >= escalation_rules.get('very_low_confidence', {}).get('threshold', 0.5):
            # Medium-low confidence - add verification
            return {
                'action': EscalationAction.VERIFY,
                'route_to': 'verifier-code-agent',
                'difficulty': difficulty.value,
                'confidence': confidence,
                'threshold': threshold,
                'reason': f"Confidence {confidence:.2f} < threshold {threshold:.2f} for {difficulty.value} task, adding verification",
                'description': "Confidence below threshold, adding verification layer",
                'verification_needed': True,
                'verification_skill': 'verifier-code-agent'
            }
        else:
            # Very low confidence - ask user
            return {
                'action': EscalationAction.ASK_USER,
                'route_to': None,
                'difficulty': difficulty.value,
                'confidence': confidence,
                'threshold': threshold,
                'reason': f"Very low confidence {confidence:.2f} for {difficulty.value} task, requires human input",
                'description': "Confidence too low for autonomous action, requires human input",
                'verification_needed': False,
                'suggested_questions': [
                    "Does this approach meet your requirements?",
                    "Are there any concerns about the implementation?",
                    "Would you like me to proceed differently?"
                ]
            }

    def should_verify(
        self,
        task: str,
        confidence: float,
        intent: Optional[str] = None
    ) -> bool:
        """
        Quick check if verification is needed

        Args:
            task: User task description
            confidence: Confidence score
            intent: Optional intent classification

        Returns:
            True if verification should be added
        """
        route = self.route_task(task, confidence, intent)
        return route['verification_needed']

    def get_escalation_suggestions(
        self,
        task: str,
        confidence: float
        intent: Optional[str] = None
    ) -> Dict[str, Any]:
        """
        Get escalation suggestions with detailed reasoning

        Args:
            task: User task description
            confidence: Confidence score
            intent: Optional intent classification

        Returns:
            Dictionary with escalation suggestions
        """
        route = self.route_task(task, confidence, intent)

        # Build detailed explanation
        explanation = {
            'task_summary': f"Task: {task}",
            'classified_difficulty': route['difficulty'],
            'confidence_level': self._get_confidence_label(confidence),
            'threshold': f"{route['threshold']:.2f}",
            'confidence_meets_threshold': confidence >= route['threshold'],
            'action': route['action'].value,
            'reasoning': route['reason']
        }

        # Add suggested questions for low confidence
        if route['action'] == EscalationAction.ASK_USER:
            explanation['suggested_questions'] = route.get('suggested_questions', [])

        return explanation

    def _get_confidence_label(self, confidence: float) -> str:
        """
        Get human-readable confidence label

        Args:
            confidence: Confidence score (0.0 to 1.0)

        Returns:
            Human-readable label
        """
        if confidence >= 0.9:
            return "Very High"
        elif confidence >= 0.7:
            return "High"
        elif confidence >= 0.5:
            return "Medium"
        elif confidence >= 0.3:
            return "Low"
        else:
            return "Very Low"

    def calculate_required_confidence(
        self,
        task: str,
        intent: Optional[str] = None
    ) -> float:
        """
        Calculate required confidence for a task

        Args:
            task: User task description
            intent: Optional intent classification

        Returns:
            Required confidence level (0.0 to 1.0)
        """
        difficulty = self.classify_difficulty(task)
        return self.get_confidence_threshold(difficulty, intent)

    def batch_route_tasks(
        self,
        tasks: List[Tuple[str, float]],
        intent: Optional[str] = None
    ) -> List[Dict[str, Any]]:
        """
        Route multiple tasks

        Args:
            tasks: List of (task, confidence) tuples
            intent: Optional intent for all tasks

        Returns:
            List of routing decisions
        """
        results = []

        for task, confidence in tasks:
            route = self.route_task(task, confidence, intent)
            results.append(route)

        return results

    def get_statistics(self) -> Dict[str, Any]:
        """
        Get router statistics

        Returns:
            Dictionary with configuration summary
        """
        escalation_rules = self.config.get('escalation_rules', {})

        return {
            'low_confidence_threshold': escalation_rules.get('low_confidence', {}).get('threshold', 0.7),
            'very_low_confidence_threshold': escalation_rules.get('very_low_confidence', {}).get('threshold', 0.5),
            'high_confidence_threshold': escalation_rules.get('high_confidence', {}).get('threshold', 0.9),
            'task_multipliers': self.config.get('task_difficulty_multipliers', {}),
            'intent_specific_rules': self.config.get('intent_rules', {}),
            'confidence_thresholds': self.config.get('confidence_thresholds', {})
        }


# Singleton instance
_router_instance = None
_instance_lock = None  # Lazy import


def get_confidence_router(config_path: str = ".opencode/config/confidence-routes.yaml") -> ConfidenceRouter:
    """
    Get singleton confidence router instance

    Args:
        config_path: Path to configuration file

    Returns:
        ConfidenceRouter instance
    """
    global _router_instance

    if _router_instance is None:
        _router_instance = ConfidenceRouter(config_path)

    return _router_instance


# CLI interface for testing
if __name__ == '__main__':
    import argparse
    import sys

    parser = argparse.ArgumentParser(
        description='Confidence-Based Task Router'
    )
    subparsers = parser.add_subparsers(dest='command', help='Available commands')

    # Route command
    route_parser = subparsers.add_parser('route', help='Route a task')
    route_parser.add_argument('task', help='Task description')
    route_parser.add_argument('--confidence', type=float, required=True, help='Confidence score (0.0-1.0)')
    route_parser.add_argument('--intent', help='Intent classification (optional)')

    # Batch route command
    batch_parser = subparsers.add_parser('batch', help='Route multiple tasks')
    batch_parser.add_argument('tasks', help='JSON array of [{"task": "...", "confidence": 0.X}]')
    batch_parser.add_argument('--intent', help='Intent classification for all tasks (optional)')

    # Stats command
    stats_parser = subparsers.add_parser('stats', help='Get router statistics')

    # Config command
    config_parser = subparsers.add_parser('config', help='View configuration')

    args = parser.parse_args()

    if not args.command:
        parser.print_help()
        sys.exit(1)

    router = get_confidence_router()

    if args.command == 'route':
        result = router.route_task(
            task=args.task,
            confidence=args.confidence,
            intent=args.intent
        )

        print("\n=== ROUTING DECISION ===")
        print(f"Task: {args.task}")
        print(f"Difficulty: {result['difficulty']}")
        print(f"Confidence: {result['confidence']:.2f} ({result['threshold']:.2f} threshold)")
        print(f"Action: {result['action'].value}")

        if result['verification_needed']:
            print(f"Route to: {result['route_to']}")
        print(f"Reason: {result['reason']}")
        else:
            print(f"Reason: {result['reason']}")

    elif args.command == 'batch':
        import json
        tasks_data = json.loads(args.tasks)

        results = router.batch_route_tasks(tasks_data, args.intent)

        print(f"\n=== BATCH ROUTING ({len(results)} tasks) ===\n")

        for i, result in enumerate(results, 1):
            print(f"Task {i}:")
            print(f"  Action: {result['action'].value}")
            print(f"  Reason: {result['reason']}")
            if result['route_to']:
                print(f"  Route to: {result['route_to']}")
            print()

    elif args.command == 'stats':
        stats = router.get_statistics()

        print("\n=== ROUTER CONFIGURATION ===")
        print(f"Low confidence threshold: {stats['low_confidence_threshold']}")
        print(f"Very low confidence threshold: {stats['very_low_confidence_threshold']}")
        print(f"High confidence threshold: {stats['high_confidence_threshold']}")
        print(f"\nTask difficulty multipliers:")
        for difficulty, data in stats['task_multipliers'].items():
            print(f"  {difficulty.value}: {data['multiplier']}x")

    elif args.command == 'config':
        import json
        print("\n=== FULL CONFIGURATION ===")
        print(json.dumps(router.config, indent=2))

    else:
        parser.print_help()
        sys.exit(1)
