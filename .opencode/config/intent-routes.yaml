# Intent Routing Configuration
# Defines how Tachikoma orchestrator routes tasks based on classified intent
# Version: 1.1.3
#
# ⚠️  CRITICAL: Skill vs Subagent Distinction
# -----------------------------------------
# SKILL:    Guidance document that you LOAD and FOLLOW
#           Usage: skill({ name: "code-agent" })
#           Output: Returns <skill_content> block with instructions
#           Then: Execute using tools directly (Edit, Read, Grep, etc.)
#           Examples: code-agent, analysis-agent, research-agent
#
# SUBAGENT: Delegated worker that you INVOKE
#           Usage: task(subagent_type="{name}", ...)
#           Then: Wait for subagent to complete and return result
#           Examples: rlm-subcall, rlm-optimized
#
# NEVER use task() for skills or skill() for subagents!
# -----------------------------------------

# SKILL CHAINS: Load multiple skills sequentially
# Usage: Call skill() for each skill in the chain
# Example:
#   1. skill({ name: "code-agent" }) → execute
#   2. skill({ name: "verifier-code-agent" }) → execute
#   3. skill({ name: "formatter" }) → execute
# -----------------------------------------

# ============================================
# INTENT ROUTES
# ============================================
routes:
  # Debug: Finding and fixing issues
  debug:
    description: Finding and fixing issues, troubleshooting
    confidence_threshold: 0.7
    context_modules:
      - 00-core-contract
      - 10-coding-standards
      - 12-commenting-rules  # COUPLED: Must load with coding-standards
    skill: code-agent
    skill_load_instruction: 'skill({ name: "code-agent" })'
    skill_usage: "Load skill, then follow its workflow (inspect→extract→validate→implement→verify→stop) using tools directly"
    invoke_via: skill  # skill = load and follow | subagent = delegate
    tools:
      - Read
      - Grep
      - Bash
    strategy: direct
    notes: Use for bugs, errors, and broken functionality

  # Implement: Writing or modifying code
  implement:
    description: Writing or modifying code, adding features
    confidence_threshold: 0.7
    context_modules:
      - 00-core-contract
      - 10-coding-standards
      - 12-commenting-rules  # COUPLED: Must load with coding-standards
    skill: code-agent
    skill_load_instruction: 'skill({ name: "code-agent" })'
    skill_usage: "Load skill, then follow its workflow (inspect→extract→validate→implement→verify→stop) using tools directly"
    invoke_via: skill
    tools:
      - Read
      - Write
      - Edit
      - Bash
    strategy: direct
    notes: Use for new features, components, and implementations

  # Review: Code analysis and auditing
  review:
    description: Analyzing code for quality, auditing
    confidence_threshold: 0.7
    context_modules:
      - 00-core-contract
      - 10-coding-standards
      - 12-commenting-rules  # COUPLED: Must load with coding-standards
      - 30-research-methods
    skill: analysis-agent
    skill_load_instruction: 'skill({ name: "analysis-agent" })'
    skill_usage: "Load skill, then follow its analysis workflow using tools directly"
    invoke_via: skill
    tools:
      - Read
      - Grep
    strategy: direct
    notes: Use for code quality checks, security audits, and analysis

  # Refactor: Restructuring existing code
  refactor:
    description: Restructuring and improving existing code
    confidence_threshold: 0.7
    context_modules:
      - 00-core-contract
      - 10-coding-standards
      - 12-commenting-rules  # COUPLED: Must load with coding-standards
    skill: code-agent
    skill_load_instruction: 'skill({ name: "code-agent" })'
    skill_usage: "Load skill, then follow its refactoring workflow using tools directly"
    invoke_via: skill
    tools:
      - Read
      - Write
      - Edit
      - Bash
    strategy: direct
    notes: Use for refactoring, restructuring, and code improvement

  # Research: Investigation and information gathering
  research:
    description: Finding information, investigating
    confidence_threshold: 0.6
    context_modules:
      - 00-core-contract
      - 30-research-methods
    skill: research-agent
    skill_load_instruction: 'skill({ name: "research-agent" })'
    skill_usage: "Load skill, then follow its research methodology using tools directly"
    invoke_via: skill
    tools:
      - Read
      - WebFetch
      - Grep
    strategy: direct
    notes: Use for learning APIs, understanding code, exploring solutions

  # Git: Version control operations
  git:
    description: Version control operations, commits, PRs
    confidence_threshold: 0.8
    context_modules:
      - 00-core-contract
      - 20-git-workflow
    skill: git-commit
    skill_load_instruction: 'skill({ name: "git-commit" })'
    skill_usage: "Load skill, then follow its git workflow using tools directly"
    invoke_via: skill
    tools:
      - Bash
    strategy: direct
    notes: Use for commits, branches, PRs, and git operations

  # Document: Documentation tasks
  document:
    description: Creating or updating documentation
    confidence_threshold: 0.6
    context_modules:
      - 00-core-contract
      - 12-commenting-rules  # Documentation includes code comments
    skill: self-learning
    skill_load_instruction: 'skill({ name: "self-learning" })'
    skill_usage: "Load skill, then follow its documentation workflow using tools directly"
    invoke_via: skill
    tools:
      - Read
      - Write
    strategy: direct
    notes: Use for README updates, docs, and comments

  # Complex: Large context or multi-step tasks
  complex:
    description: Multi-step tasks, large context processing
    confidence_threshold: 0.5
    context_modules:
      - 00-core-contract
    subagent: rlm-optimized
    fallback_subagent: rlm-subcall
    subagent_invoke_instruction: "task(subagent_type='rlm-optimized', description='...', prompt='...')"
    subagent_usage: "Delegate task to subagent and wait for completion"
    invoke_via: subagent  # subagent = delegate via task() | skill = load and follow
    tools:
      - Read
    strategy: rlm
    notes: Use for large codebases, bulk operations, complex analysis (uses MIT-style adaptive chunking)

  # Unclear: When intent cannot be determined
  unclear:
    description: Ambiguous or unclear user intent
    confidence_threshold: 0.0
    context_modules:
      - 00-core-contract
    action: ask
    notes: Ask user for clarification

  # Skill-Compose: Dynamic skill composition for complex tasks
  skill-compose:
    description: Combining multiple skills for compound tasks
    confidence_threshold: 0.6
    context_modules:
      - 00-core-contract
      - 10-coding-standards
      - 12-commenting-rules  # COUPLED: Must load with coding-standards
    skill: skill-composer
    skill_load_instruction: 'skill({ name: "skill-composer" })'
    skill_usage: "Load skill, then follow its composition workflow using tools directly"
    invoke_via: skill
    tools:
      - Read
      - Grep
      - Bash
    strategy: direct
    notes: Use when task requires multiple specialized skills working together

  # Optimize: Cost-aware routing and context optimization
  optimize:
    description: Token optimization, context pruning, efficiency improvements
    confidence_threshold: 0.7
    context_modules:
      - 00-core-contract
    skill: context-manager
    skill_load_instruction: 'skill({ name: "context-manager" })'
    skill_usage: "Load skill, then follow its optimization workflow using tools directly"
    invoke_via: skill
    tools:
      - Read
      - Bash
    strategy: direct
    notes: Use for context cleanup, token reduction, efficiency tuning

  # Verify: Generator-Verifier-Reviser pattern for high-reliability tasks
  verify:
    description: High-reliability code generation with verification loop
    confidence_threshold: 0.6
    context_modules:
      - 00-core-contract
      - 10-coding-standards
      - 12-commenting-rules  # COUPLED: Must load with coding-standards
    skill: verifier-code-agent
    skill_load_instruction: 'skill({ name: "verifier-code-agent" })'
    skill_usage: "Load skill, then follow its verify workflow using tools directly"
    invoke_via: skill
    tools:
      - Read
      - Write
      - Edit
      - Bash
    strategy: direct
    notes: "Use for: complex implementations, security-critical code, high-stakes fixes."

  # Reflect: Explicit self-verification and reflection
  reflect:
    description: Self-critique and adversarial verification for outputs
    confidence_threshold: 0.6
    context_modules:
      - 00-core-contract
      - 10-coding-standards
      - 12-commenting-rules  # COUPLED: Must load with coding-standards
    skill: reflection-orchestrator
    skill_load_instruction: 'skill({ name: "reflection-orchestrator" })'
    skill_usage: "Load skill, then follow its reflection workflow using tools directly"
    invoke_via: skill
    tools:
      - Read
      - Write
      - Edit
    strategy: direct
    notes: Use for complex reasoning, high-stakes decisions, and confidence verification.

  # Edit-Optimize: Model-aware edit format selection
  edit-optimize:
    description: Model-specific edit format for maximum success
    confidence_threshold: 0.7
    context_modules:
      - 00-core-contract
    skill: model-aware-editor
    skill_load_instruction: 'skill({ name: "model-aware-editor" })'
    skill_usage: "Load skill, then use hashline processor for reliable edits"
    invoke_via: skill
    tools:
      - Read
      - Write
      - Edit
    strategy: direct
    notes: Use when experiencing edit failures or working with multiple models.

# ============================================
# WORKFLOWS (Sequential - pass context through each stage)
# ============================================
# ⚠️  WORKFLOW USAGE:
# Skills execute SEQUENTIALLY - each skill sees the result of the previous.
# Use when: implement → verify → format, or research → implement
#
# Execution:
#   1. skill({ name: "code-agent" }) → executes → result
#   2. skill({ name: "verifier-code-agent" }) → sees result → executes
#   3. skill({ name: "formatter" }) → formats
#
# mode: sequential (default) - one after another
# ============================================
workflows:
  # High-reliability implementation workflow
  implement-verify:
    description: "Implementation with verification loop"
    skills: [code-agent, verifier-code-agent, formatter]
    mode: sequential
    context_modules:
      - 00-core-contract
      - 10-coding-standards
      - 12-commenting-rules

  # Research-then-implement workflow  
  research-implement:
    description: "Research followed by implementation"
    skills: [research-agent, context7, code-agent, formatter]
    mode: sequential
    context_modules:
      - 00-core-contract
      - 10-coding-standards
      - 12-commenting-rules

  # High-stakes security workflow
  security-implement:
    description: "Security-critical implementation"
    skills: [context7, code-agent, verifier-code-agent, reflection-orchestrator]
    mode: sequential
    context_modules:
      - 00-core-contract
      - 10-coding-standards
      - 12-commenting-rules

  # Review with reflection
  deep-review:
    description: "In-depth code review with self-verification"
    skills: [analysis-agent, reflection-orchestrator]
    mode: sequential
    context_modules:
      - 00-core-contract
      - 10-coding-standards
      - 12-commenting-rules

  # Complex research workflow
  complex-research:
    description: "Multi-source research with verification"
    skills: [research-agent, context7, reflection-orchestrator]
    mode: sequential
    context_modules:
      - 00-core-contract
      - 30-research-methods

# ============================================
# SKILLS BULK (All at once - inject all, agent decides)
# ============================================
# ⚠️  SKILLS BULK USAGE:
# ALL skills are loaded at once into context.
# Agent can use ANY of them as needed.
# Use when: multi-tool tasks, agent decides what to use
#
# Execution:
#   1. skill({ name: "code-agent" })
#   2. skill({ name: "verifier-code-agent" })
#   3. skill({ name: "formatter" })
#   → Agent has ALL available, picks what to use
# ============================================
skills_bulk:
  coding-all:
    description: "All coding skills available"
    skills: [code-agent, verifier-code-agent, formatter, reflection-orchestrator]

  research-all:
    description: "All research skills available"
    skills: [research-agent, context7, analysis-agent]

  full-stack:
    description: "Full coding + research capabilities"
    skills: [code-agent, verifier-code-agent, research-agent, context7, formatter, reflection-orchestrator]

# ============================================
# COMPOSITE INTENTS
# ============================================
composite:
  enabled: true
  resolution_strategy: union
  
  definitions:
    - name: implement-and-test
      components:
        - implement
        - debug
      description: Write code and verify it works
      
    - name: research-and-implement
      components:
        - research
        - implement
      description: Investigate then implement solution
      
    - name: refactor-and-test
      components:
        - implement
        - debug
      description: Refactor code with verification

# ============================================
# FALLBACK RULES
# ============================================
fallback:
  # When confidence is below threshold
  low_confidence:
    action: ask
    message: "I'm not sure how to categorize this request. Could you clarify what you're trying to do?"
  
  # When no route matches
  no_match:
    action: ask
    message: "I don't recognize this type of task. Please describe your goal in different terms."
  
  # When skill/agent is unavailable
  unavailable:
    action: escalate
    message: "The requested resource is unavailable. Trying alternative approach..."

# ============================================
# ROUTING BEHAVIOR
# ============================================
behavior:
  # Always load core-contract first
  always_load_core: true
  
  # Maximum number of context modules to load
  max_context_modules: 5
  
  # When to delegate vs handle directly
  delegation_threshold:
    tokens: 2000
    confidence: 0.7
  
  # Whether to report routing decisions to user
  report_routing: true
  
  # Whether to include alternative intents in reports
  report_alternatives: true
  
  # Context coupling rules
  module_coupling:
    # When coding-standards loads, commenting-rules MUST also load
    10-coding-standards:
      must_co_load:
        - 12-commenting-rules
      reason: "Commenting rules are inseparable from coding standards"

# ============================================
# CONTEXT MODULE PRIORITY
# ============================================
# Lower number = higher priority (loaded first)
module_priority:
  00-core-contract: 0
  10-coding-standards: 10
  12-commenting-rules: 12  # Bumped up from 15 - tightly coupled with coding-standards
  20-git-workflow: 20
  30-research-methods: 30
  50-prompt-safety: 50

# ============================================
# RESOURCE TYPE REFERENCE
# ============================================
# Quick lookup for skill vs subagent confusion
#
# SKILLS (Load with Read, execute yourself):
#   code-agent:              .opencode/skills/code-agent/SKILL.md
#   analysis-agent:          .opencode/skills/analysis-agent/SKILL.md
#   research-agent:          .opencode/skills/research-agent/SKILL.md
#   verifier-code-agent:     .opencode/skills/verifier-code-agent/SKILL.md
#   model-aware-editor:      .opencode/skills/model-aware-editor/SKILL.md
#   reflection-orchestrator: .opencode/skills/reflection-orchestrator/SKILL.md
#   skill-composer:          .opencode/skills/skill-composer/SKILL.md
#   context-manager:         .opencode/skills/context-manager/SKILL.md
#   context7:                .opencode/skills/context7/SKILL.md
#   formatter:               .opencode/skills/formatter/SKILL.md
#   git-commit:              .opencode/skills/git-commit/SKILL.md
#   self-learning:           .opencode/skills/self-learning/SKILL.md
#
# WORKFLOWS (Sequential - pass context through each stage):
#   Skills execute SEQUENTIALLY - each skill sees result of previous
#   Example: implement-verify workflow
#     1. skill({ name: "code-agent" }) → execute
#     2. skill({ name: "verifier-code-agent" }) → sees result → execute
#     3. skill({ name: "formatter" }) → format
#
# SKILLS BULK (All at once - inject all, agent decides):
#   ALL skills loaded at once, agent picks what to use
#   Example:
#     1. skill({ name: "code-agent" })
#     2. skill({ name: "verifier-code-agent" })
#     3. skill({ name: "formatter" })
#     → Agent has ALL available, uses as needed
#
# SUBAGENTS (Delegate with task()):
#   rlm-subcall:    task(subagent_type='rlm-subcall', ...)
#   rlm-optimized:  task(subagent_type='rlm-optimized', ...)
#
# RULES:
#   If route has 'skill:' key → use skill() to load
#   If route has 'subagent:' key → use task() to delegate
#   If route matches a workflow → execute skills sequentially
#   If route matches skills_bulk → load all skills at once
# ============================================

# ============================================
# INTENT DETECTION KEYWORDS
# Used by CLI router for fast pattern matching
# ============================================
intent_keywords:
  debug:
    - "fix"
    - "debug"
    - "broken"
    - "error"
    - "bug"
    - "issue"
    - "not working"

  implement:
    - "add"
    - "implement"
    - "create"
    - "write"
    - "build"
    - "make"
    - "feature"

  review:
    - "review"
    - "audit"
    - "check"
    - "analyze"
    - "quality"
    - "assess"

  research:
    - "research"
    - "find"
    - "investigate"
    - "look up"
    - "search"
    - "discover"

  git:
    - "git"
    - "commit"
    - "push"
    - "pull"
    - "merge"
    - "branch"
    - "pr"

  document:
    - "document"
    - "docs"
    - "readme"
    - "explain"
    - "learn"
    - "remember"

  complex:
    - "complex"
    - "large"
    - "many files"
    - "refactor"
    - "redesign"
    - "architecture"
